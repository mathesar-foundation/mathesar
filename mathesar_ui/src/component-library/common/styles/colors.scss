// ********************************************
// Token system with light/dark mode & interaction states
// ********************************************

// Utility functions
@function adjust-lightness($color, $delta) {
  @if type-of($delta) == "number" {
    @if $delta > 0 {
      @return lighten($color, $delta);
    } @else {
      @return darken($color, abs($delta));
    }
  } @else {
    @warn "adjust-lightness() expects a numeric percentage, got #{$delta}";
    @return $color;
  }
}

// ------------------------------------------
// Base colors
// ------------------------------------------

// Light
$base-hue-light: 42;
$base-saturation-light: 5%;

// Dark
$base-hue-dark: 230;
$base-saturation-dark: 4%;

// ------------------------------------------
// Surfaces
// ------------------------------------------

// Light mode anchor
$surface-base-light: hsl($base-hue-light, $base-saturation-light, 98%);

// Lightness adjustments
$surface-deltas-light: (
  "input": -2%,
  "inset": -1%,
  "canvas": 2%,
  "supporting": 3%,
  "header-primary": 4%,
  "footer": 4%,
  "header-table": 4%,
  "fieldset": 4%,
  "card": 5%,
  "control": 5%,
  "header-section": 5%,
  "elevated": 6%,
  "overlay": 8%,
  "overlay-secondary": 12%,
  "overlay-tertiary": 16%,
  "tooltip": 18%,
  "inverted": 90%
);

// Dark mode anchor
$surface-base-dark: hsl($base-hue-dark, $base-saturation-dark, 2%);

// Darkness adjustments, ordered by elevation
$surface-deltas-dark: (
  "input": -2%,
  "inset": -1%,
  "canvas": 2%,
  "supporting": 3%,
  "header-primary": 2%,
  "footer": 4%,
  "header-table": 4%,
  "fieldset": 4%,
  "card": 5%,
  "control": 5%,
  "header-section": 5%,
  "elevated": 6%,
  "overlay": 8%,
  "overlay-secondary": 12%,
  "overlay-tertiary": 16%,
  "tooltip": 18%,
  "inverted": 90%
);

$surface-states-light: (
  "hover": -3%,
  "active": -6%,
  "focused": 2%,
  "disabled": 8%,
  "muted": 5%,
  "selected": -5%,
  "highlighted": -6%,
  "highlighted-secondary": -3%
);

$surface-states-dark: (
  "hover": 3%,
  "active": 6%,
  "focused": 2%,
  "disabled": 1%,
  "muted": 5%,
  "selected": 5%,
  "highlighted": 6%,
  "highlighted-secondary": 3%
);

// Token generator mixin
@mixin generate-surface-tokens($prefix, $base-color, $states) {
  --SYS-surface-#{$prefix}: #{$base-color};
  @each $state, $delta in $states {
    --SYS-surface-#{$prefix}-#{$state}: #{adjust-lightness($base-color, $delta)};
  }
}


// ------------------------------------------
// Borders
// ------------------------------------------

// Ordered by prominence.
$border-roles: (
  "grid": 10%,
  "avatar": 10%,
  "token": 10%,
  "dropdown": 10%,
  "modal": 15%,
  "container": 12%,
  "card": 15%,
  "elevated-low": 20%,
  "elevated-mid": 25%,
  "fieldset": 26%,
  "row": 26%,
  "elevated-high": 30%,
  "input": 30%
  "canvas": 30%,
  "section": 30%,
  "control": 40%,
  "table-header": 40%,
);

$border-states-light: (
  "hover": -3%,
  "active": -6%,
  "focused": -4%,
  "disabled": 10%,
  "muted": 5%,
  "selected": -5%,
  "highlighted": -4%
);

$border-states-dark: (
  "hover": 6%,
  "active": 14%,
  "focused": 10%,
  "disabled": 8%,
  "muted": 5%,
  "selected": 5%,
  "highlighted": 4%
);

// Token generator mixin
@mixin generate-border-tokens($prefix, $base-color, $states) {
  --SYS-border-#{$prefix}: #{$base-color};
  @each $state, $delta in $states {
    --SYS-border-#{$prefix}-#{$state}: #{adjust-lightness($base-color, $delta)};
  }
}


// ------------------------------------------
// Focus Indicators
// ------------------------------------------
$focus-indicator-tokens: (
  "input": (l: 35%, s: 7%),
  "control": (l: 32%, s: 10%),
  "table-cell": (l: 34%, s: 6%),
  "row": (l: 33%, s: 6%),
  "modal": (l: 30%, s: 5%),
  "menu-item": (l: 36%, s: 8%),
  "card": (l: 38%, s: 4%),
  "tag": (l: 37%, s: 6%),
  "custom": (l: 32%, s: 10%)
);

// Token generator mixin
@mixin generate-focus-indicator-tokens($tokens, $base-hue) {
  @each $name, $props in $tokens {
    $l: map-get($props, l);
    $s: map-get($props, s);
    $color: hsl($base-hue, $s, $l);
    --SYS-indicator-#{$name}: #{$color};
  }
}


// ------------------------------------------
// Text
// ------------------------------------------
$text-tokens-light: (
  "canvas": (h: none, l:30%, s: 3%),
  "code": (h: none, l:15%, s: 4%),
  "container-title": (h: none, l:10%, s: 5%),
  "control": (h: none, l:10%, s: 5%),
  "disabled": (h: none, l:60%, s: -4%),
  "elevated": (h: none, l:10%, s: 5%),
  "footnote": (h: none, l:30%, s: 3%),
  "header-primary": (h: none, l:8%, s: 5%),
  "header-secondary": (h: none, l:10%, s: 5%),
  "header-tertiary": (h: none, l:25%, s: 3%),
  "header-subsection": (h: none, l:20%, s: 4%),
  "input": (h: none, l:10%, s: 5%),
  "input-label": (h: none, l:20%, s: 4%),
  "inverse": (h: none, l:95%, s: 4%),
  "label-fieldset": (h: none, l:20%, s: 4%),
  "link": (h: none, l:10%, s: 5%),
  "muted": (h: none, l:35%, s: 2%),
  "overlay": (h: none, l:10%, s: 5%),
  "primary": (h: none, l:10%, s: 5%),
  "secondary": (h: none, l:20%, s: 4%),
  "section-label": (h: none, l:20%, s: 4%),
  "tertiary": (h: none, l:30%, s: 3%),
  "token": (h: none, l:10%, s: 5%),
  "tooltip": (h: none, l:10%, s: 5%)
);

$text-tokens-dark: (
  "canvas": (h: none, l:60%, s: 3%),
  "code": (h: none, l:80%, s: 4%),
  "container-title": (h: none, l:92%, s: 5%),
  "control": (h: none, l:90%, s: 5%),
  "disabled": (h: none, l:35%, s: 2%),
  "elevated": (h: none, l:90%, s: 5%),
  "faint": (h: none, l:15%, s: 1%),
  "footnote": (h: none, l:55%, s: 3%),
  "header-primary": (h: none, l:92%, s: 5%),
  "header-secondary": (h: none, l:75%, s: 12%),
  "header-tertiary": (h: none, l:55%, s: 3%),
  "header-subsection": (h: none, l:75%, s: 4%),
  "input": (h: none, l:95%, s: 10%),
  "input-label": (h: none, l:70%, s: 4%),
  "inverse": (h: none, l:10%, s: 4%),
  "label-fieldset": (h: none, l:60%, s: 4%),
  "link": (h: none, l:90%, s: 5%),
  "muted": (h: none, l:45%, s: 2%),
  "overlay": (h: none, l:90%, s: 5%),
  "primary": (h: none, l:90%, s: 5%),
  "secondary": (h: none, l:65%, s: 4%),
  "section-label": (h: none, l:75%, s: 4%),
  "tertiary": (h: none, l:60%, s: 3%),
  "token": (h: none, l:85%, s: 4%),
  "tooltip": (h: none, l:88%, s: 4%)
);


$text-states-light: (
  "hover": -3%,
  "active": -6%,
  "focused": -4%,
  "disabled": 10%,
  "muted": 5%,
  "selected": -5%,
  "highlighted": -4%
);

$text-states-dark: (
  "hover": 3%,
  "active": 6%,
  "focused": 4%,
  "disabled": -10%,
  "muted": -5%,
  "selected": 5%,
  "highlighted": 4%
);

// Token generator mixin
@mixin generate-text-tokens($prefix, $base-color, $states) {
  --SYS-text-#{$prefix}: #{$base-color};
  @each $state, $delta in $states {
    --SYS-text-#{$prefix}-#{$state}: #{adjust-lightness($base-color, $delta)};
  }
}

// ------------------------------------------
// Utility boxes + buttons
// ------------------------------------------

$button-intents: (
  "success": 145,
  "warning": 50,
  "danger": 8,
  "info": 215,
  "help": 185,
  "tip": 165,
  "outcome": 275
);

$button-saturation: 35%;
$button-tones: (solid, soft, outlined, ghost);
$button-roles: (bg, text, icon, border);

$button-roles-light: (
  "bg": 94%,
  "text": 30%,
  "icon": 35%,
  "border": 80%
);

$button-roles-dark: (
  "bg": 10%,
  "text": 70%,
  "icon": 65%,
  "border": 15%
);

$button-state-deltas-light: (
  "hover": (-3%, 3%, 0),
  "active": (-6%, 0%, 0),
  "focused": (-3%, 5%, 5),
  "disabled": (10%, -100%, 0),
  "muted": (5%, -20%, 0),
  "selected": (-5%, 10%, 0),
  "highlighted": (-4%, 8%, -10)
);

$button-state-deltas-dark: (
  "hover": (3%, 3%, 0),
  "active": (6%, 0%, 0),
  "focused": (3%, 5%, 5),
  "disabled": (-10%, -100%, 0),
  "muted": (-5%, -20%, 0),
  "selected": (5%, 10%, 0),
  "highlighted": (4%, 8%, -10)
);

// Token generator mixin
@mixin generate-color-tokens($intent, $hue, $roles) {
  @each $role, $l in $roles {
    $color: hsl($hue, $button-saturation, $l);
    --SYS-color-#{$intent}-#{$role}: #{$color};
  }
}

// Token generator mixin
@mixin generate-button-tokens($intent, $tone, $base-values, $deltas) {
  @each $role in $button-roles {
    $val: map-get($base-values, $role);
    @if $val != null {
      $hue: nth($val, 1);
      $s: nth($val, 2);
      $l: nth($val, 3);
      $color: hsl($hue, $s, $l);
      --SYS-button-#{$intent}-#{$tone}-#{$role}: #{$color};
      @each $state, $delta in $deltas {
        $dl: nth($delta, 1);
        $ds: nth($delta, 2);
        $dh: nth($delta, 3);
        $lh: ($hue + $dh) % 360;
        $ls: max(0%, min(100%, $s + $ds));
        $ll: max(0%, min(100%, $l + $dl));
        $variant: hsl($lh, $ls, $ll);
        --SYS-button-#{$intent}-#{$tone}-#{$role}-#{$state}: #{$variant};
      }
    }
  }
}


// ------------------------------------------
// Accents
// ------------------------------------------

$accent-families: (
  "tomato": (8, 60%),
  "pumpkin": (33, 90%),
  "amethyst": (270, 35%),
  "salmon": (12, 79%),
  "wisteria": (250, 35%),
  "glacier": (190, 35%),
  "asparagus": (90, 45%),
  "fjord": (220, 30%)
);

$accent-roles-light: (
  "base": (1.0, 1.0, 50%),
  "faint": (1.0, 0.6, 95%),
  "muted": (1.0, 0.6, 80%),
  "dull": (1.0, 0.6, 75%),
  "bright": (1.0, 1.0, 30%),
  "contrast": (1.0, 1.0, 15%),
  "inverted": (1.0, 1.0, 5%),
  "text": (1.2, 1.0, 35%),
  "on": (0.05, 1.0, 96%),
  "border": (0.6, 1.0, 70%)
);

$accent-roles-dark: (
  "base": (1.0, 1.0, 50%),
  "faint": (1.0, 0.6, 5%),
  "muted": (1.0, 0.6, 15%),
  "dull": (1.0, 0.6, 30%),
  "bright": (1.0, 1.0, 75%),
  "contrast": (1.0, 1.0, 85%),
  "inverted": (1.0, 1.0, 95%),
  "text": (1.2, 1.0, 65%),
  "on": (0.05, 1.0, 10%),
  "border": (0.6, 1.0, 40%)
);

$accent-states: (
  "hover": (-3%, 3%, 0),
  "active": (-6%, 0%, 0),
  "focused": (-3%, 5%, 5),
  "disabled": (10%, -100%, 0),
  "muted": (5%, -20%, 0),
  "selected": (-5%, 10%, 0),
  "highlighted": (-4%, 8%, -10)
);

// Token generator mixin
@mixin generate-accent-tokens($name, $hue, $sat, $roles) {
  @each $role, $params in $roles {
    $sat-mult: nth($params, 1);
    $light-mult: nth($params, 2);
    $light: nth($params, 3);
    $s: $sat * $sat-mult;
    $l: $light;
    $color: hsl($hue, $s, $l);
    --SYS-accent-#{$name}-#{$role}: #{$color};
    @each $state, $delta in $accent-states {
      $dl: nth($delta, 1);
      $ds: nth($delta, 2);
      $dh: nth($delta, 3);
      $sh: max(0%, min(100%, $s + $ds));
      $lh: max(0%, min(100%, $l + $dl));
      $hh: ($hue + $dh) % 360;
      $variant: hsl($hh, $sh, $lh);
      --SYS-accent-#{$name}-#{$role}-#{$state}: #{$variant};
    }
  }
}


// ------------------------------------------
// GENERATE COLORS IN THEMES
// ------------------------------------------
body {
  // Surfaces
  @include generate-surface-tokens(base, $surface-base-light, $surface-states-light);

  @each $name, $delta in $surface-deltas-light {
    $base: adjust-lightness($surface-base-light, $delta);
    @include generate-surface-tokens(#{$name}, $base, $surface-states-light);
  }

  // Borders
  @each $name, $delta in $border-roles {
    $base: hsl($base-hue-light, $base-saturation-light, $delta);
    @include generate-border-tokens(#{$name}, $base, $border-states-light);
  }

  // Focus indicators
  @include generate-focus-indicator-tokens($focus-indicator-tokens,  $base-hue-light);

  // Text
  @each $name, $props in $text-tokens-light {
    $hue: map-get($props, h);
    @if $hue == none {
      $hue: $base-hue-light;
    }
    $base: hsl($hue, map-get($props, s), map-get($props, l));
    @include generate-text-tokens(#{$name}, $base, $text-states-light);
  }

  // Semantic colors and buttons
  @each $intent, $hue in $button-intents {
    @include generate-color-tokens($intent, $hue, $button-roles-light);

    $solid: (bg: ($hue, $button-saturation, 30%), text: ($hue, 5%, 96%), icon: ($hue, 5%, 96%), border: ($hue, $button-saturation, 24%));
    $soft: (bg: ($hue, $button-saturation * 0.4, 92%), text: ($hue, $button-saturation, 32%), icon: ($hue, $button-saturation, 32%), border: ($hue, $button-saturation * 0.6, 84%));
    $outlined: (bg: null, text: ($hue, $button-saturation, 32%), icon: ($hue, $button-saturation, 32%), border: ($hue, $button-saturation * 0.8, 70%));
    $ghost: (bg: null, text: ($hue, $button-saturation * 0.5, 45%), icon: ($hue, $button-saturation * 0.5, 45%), border: null);

    @include generate-button-tokens($intent, solid, $solid, $button-state-deltas-light);
    @include generate-button-tokens($intent, soft, $soft, $button-state-deltas-light);
    @include generate-button-tokens($intent, outlined, $outlined, $button-state-deltas-light);
    @include generate-button-tokens($intent, ghost, $ghost, $button-state-deltas-light);
  }

  // Accent colors
  @each $name, $props in $accent-families {
    $hue: nth($props, 1);
    $sat: nth($props, 2);
    @include generate-accent-tokens($name, $hue, $sat, $accent-roles-light);
  }
  //**********
  // Dark theme
  //**********
  &.theme-dark {

    // Surfaces
    @include generate-surface-tokens(base, $surface-base-dark, $surface-states-dark);

    @each $name, $delta in $surface-deltas-dark {
      $base: adjust-lightness($surface-base-dark, $delta);
      @include generate-surface-tokens(#{$name}, $base, $surface-states-dark);
    }

    // Borders
    @each $name, $delta in $border-roles {
      $base: hsl($base-hue-dark, $base-saturation-dark, $delta);
      @include generate-border-tokens(#{$name}, $base, $border-states-dark);
    }

    // Focus indicators
    @include generate-focus-indicator-tokens($focus-indicator-tokens, $base-hue-dark);

    // Text
    @each $name, $props in $text-tokens-dark {
      $hue: map-get($props, h);
      @if $hue == none {
        $hue: $base-hue-dark;
      }
      $base: hsl($hue, map-get($props, s), map-get($props, l));
      @include generate-text-tokens(#{$name}, $base, $text-states-dark);
    }

    // Semantic colors and buttons
    @each $intent, $hue in $button-intents {
      @include generate-color-tokens($intent, $hue, $button-roles-dark);

      $solid: (bg: ($hue, $button-saturation, 70%), text: ($hue, 5%, 10%), icon: ($hue, 5%, 10%), border: ($hue, $button-saturation, 64%));
      $soft: (bg: ($hue, $button-saturation * 0.4, 18%), text: ($hue, $button-saturation, 75%), icon: ($hue, $button-saturation, 75%), border: ($hue, $button-saturation * 0.6, 26%));
      $outlined: (bg: null, text: ($hue, $button-saturation, 75%), icon: ($hue, $button-saturation, 75%), border: ($hue, $button-saturation * 0.8, 30%));
      $ghost: (bg: null, text: ($hue, $button-saturation * 0.5, 60%), icon: ($hue, $button-saturation * 0.5, 60%), border: null);

      @include generate-button-tokens($intent, solid, $solid, $button-state-deltas-dark);
      @include generate-button-tokens($intent, soft, $soft, $button-state-deltas-dark);
      @include generate-button-tokens($intent, outlined, $outlined, $button-state-deltas-dark);
      @include generate-button-tokens($intent, ghost, $ghost, $button-state-deltas-dark);
    }

    // Accent colors
    @each $name, $props in $accent-families {
      $hue: nth($props, 1);
      $sat: nth($props, 2);
      @include generate-accent-tokens($name, $hue, $sat, $accent-roles-dark);
    }
  }
}
