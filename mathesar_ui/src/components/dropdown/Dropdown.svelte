<script lang="ts">
  import {
    faAngleDown,
  } from '@fortawesome/free-solid-svg-icons';
  import {
    portal,
    popper,
    Button,
    Icon,
    clickOffBounds,
  } from '@mathesar-components';
  import type {
    Appearance,
  } from '@mathesar-components/types';
  import type { Placement } from '@popperjs/core/lib/enums';
  import {
    createEventDispatcher, getContext, setContext,
  } from 'svelte';

  const dispatch = createEventDispatcher();

  export let triggerClass = '';
  export let triggerAppearance : Appearance = 'default';
  export let contentClass = '';
  export let isOpen = false;
  export let closeOnInnerClick = false;
  export let ariaLabel:string = null;
  export let ariaControls: string = null;
  export let placement: Placement = 'bottom-start';
  export let showArrow = true;

  // Relevant when this Dropdown is a child of another Dropdown. We need to
  // "get" before we "set", otherwise the value will always be `true`.
  const isWithinDropdown = getContext('isWithinDropdown') ?? false;

  // Relevant when this Dropdown is a parent of another Dropdown.
  setContext('isWithinDropdown', true);
  
  let trigger: HTMLElement;

  function calculateTriggerClass(_triggerClass: string, _showArrow: boolean): string {
    const classes = ['dropdown', 'trigger'];
    if (_triggerClass) {
      classes.push(_triggerClass);
    }
    if (!_showArrow) {
      classes.push('no-arrow');
    }
    return classes.join(' ');
  }

  $: tgClasses = calculateTriggerClass(triggerClass, showArrow);

  function toggle() {
    isOpen = !isOpen;
  }

  function close() {
    isOpen = false;
  }

  function checkAndCloseOnInnerClick() {
    if (closeOnInnerClick) {
      close();
    }
  }

  function dispatchOnOpen(_isOpen: boolean) {
    if (_isOpen) {
      dispatch('open');
    }
  }

  $: dispatchOnOpen(isOpen);
</script>

<Button bind:element={trigger} appearance={triggerAppearance} class={tgClasses} on:click={toggle} 
  aria-controls={ariaControls} aria-haspopup="listbox" aria-label={ariaLabel} on:keydown>
  <span class="label">
    <slot name="trigger"></slot>
  </span>
  {#if showArrow}
    <span class="arrow">
      <Icon data={faAngleDown}/>
    </span>
  {/if}
</Button>

{#if isOpen}
  <div
    class={['dropdown content', contentClass].join(' ')}
    use:portal={{ isEnabled: !isWithinDropdown }}
    use:popper={{ reference: trigger, options: { placement } }}
    use:clickOffBounds={{
      callback: close,
      references: [trigger],
    }}
    on:click={checkAndCloseOnInnerClick}
  >
    <slot name="content"></slot>
  </div>
{/if}

<style global lang="scss">
  @import "Dropdown.scss";
</style>
